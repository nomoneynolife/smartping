<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="utf-8">
    <title>SmartPing Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="assets/css/font-awesome.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="assets/css/pages/dashboard.css" rel="stylesheet">
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <style>
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
            padding: 15px;
        }
        .chart-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid #e8e8e8;
        }
        .chart-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-color: #d9d9d9;
        }
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 12px;
            color: #262626;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .chart-container {
            width: 100%;
            height: 180px;
            position: relative;
        }
        .chart-status {
            position: absolute;
            top: 5px;
            right: -3px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #f5f5f5;
        }
        .status-normal {
			right: 6px;
			min-width: 30px;
			color: #52c41a;
		}
        .status-warning { color: #faad14; }
        .status-error { color: #ff4d4f; }
    </style>
</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <span id="cloudbrand" class="brand" style="margin-right: -15px;"></span>
            <a class="brand" href="index.html">SmartPing Dashbord<span id="agentname"></span></a>
            <span id="banner_last_ck_time" class="pull-right" style="margin-top: 10px;"></span>
        </div>
    </div>
</div>

<div class="subnavbar">
    <div class="subnavbar-inner">
        <div class="container">
            <ul class="mainnav">
                <li class="active"><a href="index.html"><i class="icon-mail-forward"></i><span>正向Ping</span></a></li>
                <li><a href="reverse.html"><i class="icon-mail-reply"></i><span>反向Ping</span></a></li>
                <li><a href="topology.html"><i class="icon-bar-chart"></i><span>Ping拓扑</span></a></li>
                <li><a href="mapping.html"><i class="icon-map-marker"></i><span>全国延迟</span></a></li>
                <li><a href="tools.html"><i class="icon-wrench"></i><span>检测工具</span></a></li>
                <li><a id="cfgUrl" href="config.html"><i class="icon-cog"></i><span>系统配置</span></a></li>
            </ul>
        </div>
    </div>
</div>

<div class="main" style="margin-top:-20px;">
    <div class="main-inner">
        <div class="container">
            <div class="row">
                <div id="main" class="span10">
                    <div id="lineChart" class="chart-grid"></div>
                </div>
                
                <div class="span2">
                    <div class="widget widget-table action-table">
                        <div class="widget-header">
                            <i class="icon-th-list"></i>
                            <h3 style="margin-top: -5px;">节点列表</h3>
                        </div>
                        <div class="widget-content">
                            <table class="table table-striped table-bordered">
                                <thead></thead>
                                <tbody class="agentlist"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="footer">
    <div class="footer-inner">
        <div class="container">
            <div class="row">
                <div class="span12">
                    &copy; 2017 - 2020 <a target="_blank" href="http://smartping.org">SmartPing.org</a>
                    <span style="float:right" id="verion"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 原始的大图模态框 -->
<div id="charts" class="modal fade" tabindex="-1" style="width: 830px;height:500px;">
    <input type="hidden" id="pannelurl" value=""/>
    <div class="modal-dialog">
        <div class="modal-content">
            <div style="text-align:center;padding-top:10px;">
                <b>StartTime:</b>&nbsp;<input id="starttime" type='text' onClick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm'})" style="width:120px;">
                <b>EndTime:</b>&nbsp;<input id="endtime" type='text' onClick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm'})" style="width:120px;">
                &nbsp;<input class="sgraph" type="button" value="Submit" />
            </div>
            <div class="modal-body" id="pannel-show" style="width: 800px;height:500px;"></div>
        </div>
    </div>
</div>

<script src="assets/js/jquery-1.7.2.min.js"></script>
<script src="assets/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script language="JavaScript" type="text/javascript" src="assets/js/My97DatePicker/WdatePicker.js"></script>
<script src="assets/js/funcs.js"></script>

<script>
// 全局图表实例缓存
const chartInstances = new Map();
let myChart = null;

// 初始化页面
getLineChart("");

function changeAgent(nodeName, url) {
    $(".alerticon-" + nodeName).addClass("icon-spinner icon-spin animated");
    getLineChart(url);
}

function getLineChart(url) {
    if (url !== "") {
        url = "/api/proxy.json?g=" + url;
    }
    
    $.getJSON(url + "/api/config.json", function(result) {
        $("#lineChart").html("");
        $(".agentlist").html("");
        $("#agentname").text(" (" + result["Name"] + ")");
        AgentMode(result["Mode"]);
        $("#verion").text("Version: " + result["Ver"]);
        
        // 渲染节点列表
        $.each(result["Network"], function(i, network) {
            if (network["Smartping"]) {
                $(".agentlist").append("<tr><td><i class='alerticon-" + network["Name"] + "'></i>&nbsp;" +
                    "<a onclick=changeAgent('" + network["Name"] + "','http://" + network["Addr"] + ":" + result["Port"] + "')>" + network["Name"] + "</a></td></tr>");
            }
        });
        
        // 创建图表容器
        const currentAddr = result["Addr"];
        const pingTargets = result["Network"][currentAddr]?.["Ping"] || [];
        
        pingTargets.forEach((targetAddr, index) => {
            const chartId = "chart-" + targetAddr.replace(/\./g, "-");
            const targetName = result["Network"][targetAddr]?.["Name"] || targetAddr;
            const apiUrl = '/api/proxy.json?g=http://'+result["Addr"]+':'+result["Port"]+'/api/ping.json?ip='+targetAddr;
            
            $("#lineChart").append(`
                <div class="chart-card showcharts" apiurl="${apiUrl}">
                    <div class="chart-title">${result["Name"]} → ${targetName}</div>
                    <div class="chart-container">
                        <div id="${chartId}" style="width:100%;height:100%;"></div>
                        <span class="chart-status status-normal">● 正常</span>
                    </div>
                </div>
            `);
            
            initSmallChart(chartId, apiUrl);
        });
        
    }).fail(function(xhr, status) {
        alert(xhr.responseText);
        Refresh();
    });
}

function initSmallChart(chartId, apiUrl) {
    $.get(apiUrl).done(function(data) {
        // 清理之前的实例
        if (chartInstances.has(chartId)) {
            chartInstances.get(chartId).dispose();
        }
        
        const chart = echarts.init(document.getElementById(chartId));
        chartInstances.set(chartId, chart);
        
        const timeData = data.lastcheck || [];
        const avgDelay = data.avgdelay || [];
        const lossPk = data.losspk || [];
        
        // 计算状态
        const lastDelay = avgDelay[avgDelay.length - 1] || 0;
        const lastLoss = lossPk[lossPk.length - 1] || 0;
        let status = 'normal';
        let statusText = '正常';
        
        if (lastLoss > 50) {
            status = 'error';
            statusText = '高丢包';
        } else if (lastDelay > 100 || lastLoss > 20) {
            status = 'warning';
            statusText = '警告';
        }
        
        // 更新状态显示
        $(`#${chartId}`).siblings('.chart-status')
            .removeClass('status-normal status-warning status-error')
            .addClass(`status-${status}`)
            .text(`● ${statusText}`);
        
        const option = {
            animation: false,
            grid: {
                left: '8%',
                right: '8%',
                top: '5%',
                bottom: '5%',
                containLabel: true
            },
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(0,0,0,0.85)',
                borderWidth: 0,
                textStyle: {
                    color: '#fff',
                    fontSize: 12
                },
                formatter: function(params) {
                    let result = `<div style="padding:4px;font-size:12px;">`;
                    params.forEach(param => {
                        const value = param.value ?? 0;
                        const unit = param.seriesName === '延迟' ? 'ms' : '%';
                        const color = param.color;
                        result += `
                            <div style="display:flex;align-items:center;margin:3px 0;">
                                <span style="display:inline-block;width:10px;height:10px;background:${color};border-radius:2px;margin-right:8px;"></span>
                                <span style="flex:1;">${param.seriesName}:</span>
                                <span style="font-weight:600;color:${color};">${value.toFixed(1)}${unit}</span>
                            </div>
                        `;
                    });
                    result += `</div>`;
                    return result;
                }
            },
            xAxis: {
                type: 'category',
                data: timeData,
                show: false,
                boundaryGap: false
            },
            yAxis: [
                {
                    type: 'value',
                    min: 0,
                    position: 'left',
                    axisLine: {
                        show: true,
                        lineStyle: {
                            color: '#00CC66',
                            width: 1
                        }
                    },
                    axisLabel: {
                        show: true,
                        fontSize: 8,
                        color: '#666',
                        formatter: '{value}'
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: '#f0f0f0',
                            width: 0.5
                        }
                    }
                },
                {
                    type: 'value',
                    min: 0,
                    max: 100,
                    position: 'right',
                    axisLine: {
                        show: true,
                        lineStyle: {
                            color: '#FF0000',
                            width: 1
                        }
                    },
                    axisLabel: {
                        show: true,
                        fontSize: 8,
                        color: '#666',
                        formatter: '{value}'
                    },
                    splitLine: {
                        show: false
                    }
                }
            ],
            series: [
                {
                    name: '延迟',
                    type: 'line',
                    yAxisIndex: 0,
                    data: avgDelay,
                    smooth: 0.4,
                    symbol: 'none',
                    lineStyle: {
                        width: 2,
                        color: '#00CC66'
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(0, 204, 102, 0.4)' },
                            { offset: 1, color: 'rgba(0, 204, 102, 0.1)' }
                        ])
                    },
                    emphasis: {
                        focus: 'series',
                        lineStyle: {
                            width: 3,
                            color: '#00CC66'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0, 204, 102, 0.6)' },
                                { offset: 1, color: 'rgba(0, 204, 102, 0.2)' }
                            ])
                        }
                    }
                },
                {
                    name: '丢包率',
                    type: 'line',
                    yAxisIndex: 1,
                    data: lossPk,
                    smooth: 0.4,
                    symbol: 'none',
                    lineStyle: {
                        width: 2,
                        color: '#FF0000'
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(255, 0, 0, 0.4)' },
                            { offset: 1, color: 'rgba(255, 0, 0, 0.1)' }
                        ])
                    },
                    emphasis: {
                        focus: 'series',
                        lineStyle: {
                            width: 3,
                            color: '#FF0000'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(255, 0, 0, 0.6)' },
                                { offset: 1, color: 'rgba(255, 0, 0, 0.2)' }
                            ])
                        }
                    }
                }
            ]
        };
        
        chart.setOption(option);
        
        // 响应式调整
        const resizeChart = () => chart.resize();
        window.addEventListener('resize', resizeChart);
        
    }).fail(function(error) {
        console.error('加载图表数据失败:', error);
        document.getElementById(chartId).innerHTML = `
            <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;font-size:12px;">
                <i class="icon-warning-sign"></i> 数据加载失败
            </div>
        `;
    });
}

// 大图模态框交互 - 保持原始逻辑
$("#main").on("click",".showcharts",function(){
    var modalWidth = $("#charts").width();
    var left = "-" + parseInt(modalWidth) / 2 + "px";
    $('#charts').modal('show').css({"margin-left":left});
    
    var url = $(this).attr("apiurl");
    $("#pannelurl").val(url);
    
    // 初始化大图
    if (!myChart) {
        myChart = echarts.init(document.getElementById('pannel-show'));
        myChart.setOption(opt);
    }
    
    $.get(url).done(function(data) {
        myChart.setOption({
            xAxis: {
                data: data.lastcheck
            },
            series: [{
                name: 'maxDelay',
                data: data.maxdelay
            }, {
                name: 'minDelay',
                data: data.mindelay
            }, {
                name: 'avgDelay',
                data: data.avgdelay
            }, {
                name: 'lossPk',
                data: data.losspk
            }]
        });
    });
});

$(".sgraph").click(function(){
    var start = $("#starttime").val();
    var endtime = $("#endtime").val();
    var url = $("#pannelurl").attr("value");
    
    $.get(url + "&starttime=" + start + "&endtime=" + endtime).done(function(data) {
        myChart.setOption({
            xAxis: {
                data: data.lastcheck
            },
            series: [{
                name: 'maxDelay',
                data: data.maxdelay
            }, {
                name: 'minDelay',
                data: data.mindelay
            }, {
                name: 'avgDelay',
                data: data.avgdelay
            }, {
                name: 'lossPk',
                data: data.losspk
            }]
        });
    });
});

// 原始的大图配置
var opt = {
    title: {
        text: ''
    },
    legend: {
        data: ['maxDelay', 'avgDelay', 'minDelay', 'lossPk'],
        selected: {
            'maxDelay': false,
            'minDelay': false
        }
    },
    toolbox: {
        feature: {
            dataView: {},
            saveAsImage: {
                pixelRatio: 2
            }
        }
    },
    tooltip: {
        trigger: 'axis'
    },
    xAxis: {
        data: []
    },
    dataZoom: [{}],
    yAxis: [{
        type: 'value',
        name: 'Delay',
        position: 'left'
    }, {
        type: 'value',
        name: 'Package(LOSS)',
        min: 0,
        max: 100,
        position: 'right',
        axisLabel: {
            formatter: '{value} %'
        }
    }],
    series: [{
        name: 'maxDelay',
        type: 'line',
        animation: false,
        areaStyle: {
            normal: {}
        },
        lineStyle: {
            normal: {
                width: 0
            }
        },
        data: []
    }, {
        name: 'minDelay',
        type: 'line',
        animation: false,
        areaStyle: {
            normal: {}
        },
        lineStyle: {
            normal: {
                width: 0
            }
        },
        data: []
    }, {
        name: 'avgDelay',
        type: 'line',
        data: [],
        itemStyle: {
            normal: {
                color: '#00CC66'
            }
        },
        animation: false,
        areaStyle: {
            normal: {}
        },
        lineStyle: {
            normal: {
                width: 0
            }
        }
    }, {
        name: 'lossPk',
        type: 'line',
        yAxisIndex: 1,
        data: [],
        itemStyle: {
            normal: {
                color: '#FF0000'
            }
        },
        animation: false,
        areaStyle: {
            normal: {}
        },
        lineStyle: {
            normal: {
                width: 0
            }
        }
    }]
};

// 窗口调整大小
window.addEventListener('resize', function() {
    chartInstances.forEach(chart => chart.resize());
    if (myChart) myChart.resize();
});

window.addEventListener('beforeunload', function() {
    chartInstances.forEach(chart => chart.dispose());
    if (myChart) myChart.dispose();
});
</script>
</body>
</html>